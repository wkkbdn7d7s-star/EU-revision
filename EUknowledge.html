<script type="module">
  const { auth, db, doc, updateDoc, arrayUnion, onAuthStateChanged } = window.firebaseFns;
  const form = document.getElementById("assessment-form");
  const status = document.getElementById("form-status");

  let currentUser = null;

  onAuthStateChanged(auth, user => {
    if (user) {
      currentUser = user;
      status.textContent = "";
    } else {
      currentUser = null;
      status.textContent = "Please log in on the main page to submit scores.";
    }
  });

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    if (!currentUser) {
      status.textContent = "You must be logged in!";
      return;
    }

    const clarity = parseInt(document.getElementById("clarity").value);
    const structure = parseInt(document.getElementById("structure").value);
    const confidence = parseInt(document.getElementById("confidence").value);

    // Include timestamp to make each submission unique
    const submission = {
      clarity,
      structure,
      confidence,
      submittedAt: new Date().toISOString() // <-- ensures uniqueness
    };

    try {
      const userDoc = doc(db, "users", currentUser.uid);
      await updateDoc(userDoc, {
        "selfAssessment.EUKnowledge": arrayUnion(submission)
      });
      status.textContent = "Score submitted successfully!";
      form.reset();
    } catch (err) {
      console.error(err);
      status.textContent = "Error submitting score: " + err.message;
    }
  });
</script>
